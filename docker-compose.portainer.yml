version: '3.8'

services:
  api:
    # Replace 'yourusername' with your GitHub username
    # Image will be: ghcr.io/yourusername/tdah-printer:latest
    image: ghcr.io/${GITHUB_USER}/tdah-printer:latest
    container_name: tdah-printer-api
    network_mode: host
    user: "0"  # Root user required for USB access
    restart: unless-stopped

    environment:
      # Flask Configuration
      - FLASK_ENV=${FLASK_ENV:-production}
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG:-false}

      # Database Configuration (external PostgreSQL)
      - DATABASE_URL=${DATABASE_URL}

      # Printer Configuration
      - PRINTER_ENABLED=${PRINTER_ENABLED:-true}
      - PRINTER_VENDOR_ID=${PRINTER_VENDOR_ID:-26728}
      - PRINTER_PRODUCT_ID=${PRINTER_PRODUCT_ID:-512}
      - PRINTER_INTERFACE=${PRINTER_INTERFACE:-0}
      - PRINTER_IN_ENDPOINT=${PRINTER_IN_ENDPOINT:-129}
      - PRINTER_OUT_ENDPOINT=${PRINTER_OUT_ENDPOINT:-3}
      - PRINTER_ENCODING=${PRINTER_ENCODING:-utf-8}

      # Thermal Printer Specs
      - MAX_THERMAL_WIDTH_PX=${MAX_THERMAL_WIDTH_PX:-384}
      - THERMAL_DPI=${THERMAL_DPI:-203}
      - BOTTOM_MARGIN_MM=${BOTTOM_MARGIN_MM:-15.0}

      # Application Settings
      - UPLOAD_FOLDER=/app/uploads
      - MAX_CONTENT_LENGTH=${MAX_CONTENT_LENGTH:-16777216}

      # Pagination
      - DEFAULT_PAGE_SIZE=${DEFAULT_PAGE_SIZE:-20}
      - MAX_PAGE_SIZE=${MAX_PAGE_SIZE:-100}

      # API Documentation
      - API_TITLE=${API_TITLE:-TDAH Printer API}
      - API_VERSION=${API_VERSION:-1.0.0}
      - OPENAPI_VERSION=${OPENAPI_VERSION:-3.1.0}

      # CORS
      - CORS_ORIGINS=${CORS_ORIGINS:-*}

    volumes:
      - uploads_data:/app/uploads
      # Optional: Mount custom template if needed
      # - ./app/templates/default_note.html:/app/app/templates/default_note.html:ro

    # USB device passthrough for thermal printer
    # Update device path to match your printer (find with lsusb)
    devices:
      - /dev/bus/usb/001/012:/dev/bus/usb/001/012

    privileged: true  # Required for USB access

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/health/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  uploads_data:
    driver: local
